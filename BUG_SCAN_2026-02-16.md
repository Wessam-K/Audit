# WK POS Enterprise — Bug Scan & Quality Report

**Date:** 2026-02-16  
**Author:** Enterprise Readiness Audit (Phase 6)  
**Classification:** INTERNAL — Quality Assessment  
**Status:** 268 issues found (1 BUG, 260 WARN, 7 INFO)

---

## 1. Summary Scorecard

| Category | Issues | Critical/Bug | Warnings | Info |
|----------|--------|-------------|----------|------|
| Prisma Schema | 12 | 1 | 9 | 2 |
| Security (unvalidated routes) | ~30 | 0 | ~28 | 2 |
| TODOs in Production | 8 | 0 | 8 | 0 |
| Error Handling | 1 | 0 | 1 | 0 |
| Memory/Performance | ~15 | 0 | ~14 | 1 |
| TypeScript `as any` | 200+ | 0 | 200+ | 0 |
| `@ts-ignore` | 2 | 0 | 0 | 2 |
| **TOTAL** | **~268** | **1** | **~260** | **7** |

---

## 2. Prisma Schema Issues

### 2.1 Missing Tenant Relation (Orphan Risk)

**BUG**: `StockAlert` has `tenantId` field but **no `Tenant` relation** — orphaned rows remain after tenant deletion.

**WARN**: 7 additional models have `tenantId` but no `Tenant` relation:
- `SystemSetting`, `SavedReport`, `ApiKey`, `AccessRule`, `AccessPolicy`, `UserAttribute`, `ActivityLog`

**Fix:** Add `Tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)` to each.

### 2.2 Nullable Unique Fields

| Model | Field | Impact |
|-------|-------|--------|
| `ProductVariant` | `barcode String? @unique` | Multiple NULLs allowed — intentional |
| `Tenant` | `taxNumber String? @unique` | Multiple NULLs allowed — intentional |
| `Sale` | `idempotencyKey String? @unique` | NULL bypasses uniqueness — documented risk |
| `PurchaseOrder` | `idempotencyKey String? @unique` | Same as above |

---

## 3. Security Issues

### 3.1 Routes Without Input Validation (28 route files)

These route files destructure `req.body` without Zod validation middleware:

| Route File | Unvalidated Endpoints |
|------------|----------------------|
| `printing.routes.ts` | PUT printer settings, PUT template |
| `batch.routes.ts` | All 4 batch import endpoints |
| `website-sync.routes.ts` | Config CRUD, sync triggers (4 endpoints) |
| `loyalty.routes.ts` | All loyalty mutations (6 endpoints) |
| `webhook.routes.ts` | Webhook CRUD (2 endpoints) |
| `shift.routes.ts` | Shift open/close (3 endpoints) |
| `stocktaking.routes.ts` | Stocktaking CRUD (5 endpoints) |
| `settings.routes.ts` | Settings + lockout policy (3 endpoints) |
| `sync.routes.ts` | Most sync endpoints |

**Impact:** Unvalidated input can cause Prisma errors, inject unexpected data types, or bypass business rules.

### 3.2 Security Passes (Good)

- ✅ No sensitive data (passwords, tokens, keys) logged
- ✅ No `eval()` or `new Function()` in production code
- ✅ No `BYPASS_PERMISSIONS = true` found
- ✅ Error middleware hides stack traces in production
- ✅ No empty catch blocks found
- ✅ No `.js` source files in `src/` directories

---

## 4. Dead Code / TODOs

### 4.1 Empty Event Listeners (5 handlers doing nothing)

Location: `wk-pos-system/server/api/src/domain/listeners/eventListeners.ts`

| Line | Event | Status |
|------|-------|--------|
| L82 | `sale.refunded` | `// TODO: Implement side effects` — handler is empty |
| L113 | `sale.voided` | Same |
| L144 | `inventory.adjusted` | Same |
| L175 | `customer.created` | Same |
| L207 | `customer.updated` | Same |

**Impact:** These domain events fire but produce zero side effects. Downstream operations (notifications, audit logs, integrations) that should trigger on these events are silently skipped.

### 4.2 Other TODOs

| File | Line | TODO |
|------|------|------|
| `sale.routes.ts` | L513 | `TODO: Refactor to use proper domain flow` |
| `canonical-guards.ts` | L83 | `TODO: Make this an error after migration` |
| `access-control.routes.ts` | L111 | `TODO: When DB tables are created, persist...` |

---

## 5. Performance Issues

### 5.1 Unbounded Queries (No Pagination)

These `findMany` calls fetch ALL matching records without `take`/`limit`:

| File | Table | Risk |
|------|-------|------|
| `websocket.service.ts` L221-242 | `product`, `customer`, `category` | **HIGH** — Full table dump over WebSocket on initial sync |
| `sync.service.ts` L181-197 | `product`, `customer`, `sale` | **HIGH** — All entities since version with no cap |
| `db-sync.service.ts` L319-338 | Multiple tables | **HIGH** — Full table dumps for sync |
| `report.routes.ts` L274-457 | `product`, `customer`, `stockLevel` | **MEDIUM** — Report data without pagination |
| `low-stock-alerts.service.ts` L55-306 | `stockLevel` | **MEDIUM** — All stock levels for tenant |
| `reconciliation.service.ts` L221-355 | `stockLevel` | **MEDIUM** — All stock per branch |
| `loyalty.routes.ts` L60, L613 | `loyaltyTransaction`, `customer` | **LOW** — All transactions/customers for reports |

**Impact:** At enterprise scale (10K+ products, 50K+ sales), these queries cause OOM errors, slow responses, and database lock contention.

### 5.2 Fire-and-Forget Timer

`scheduled-report.routes.ts` L268: `setTimeout(async () => { ... }, 2000)` — async DB update in fire-and-forget timer with `console.error` (not structured logger), timer not tracked by ref.

### 5.3 Untracked Cache Timeout

`rbac.service.ts` L181: `setTimeout(() => this.permissionCache.delete(...))` — timer not tracked via ref, cannot be cancelled on shutdown.

---

## 6. TypeScript Quality

### 6.1 `as any` Usage (200+ occurrences)

| Pattern | Count | Impact |
|---------|-------|--------|
| `(req as any).user?.tenantId` | ~80 | Express `Request` type not extended |
| `(prisma as any).modelName` | ~15 | Models not recognized in Prisma client |
| `data as any` (Prisma results) | ~30 | Type safety bypassed on query results |
| `protect as any`, `requirePermission as any` | ~25 | Middleware type mismatch |
| Other misc | ~50 | Various type bypasses |

**Root Cause:** Express `Request` interface hasn't been properly extended with `user` typing. This single fix would eliminate ~80 of the 200+ `as any` casts.

**Fix:**
```typescript
// types/express.d.ts
declare namespace Express {
  interface Request {
    user?: {
      id: string;
      userId: string;
      email: string;
      tenantId: string;
      branchId?: string;
      role: string;
      permissions: string[];
      moduleAccess: string[];
      branches: string[];
    };
    branchScope?: { branchId?: string | { in: string[] } };
  }
}
```

### 6.2 `@ts-ignore` (2 — Acceptable)

Both documented with reasons. No action needed.

---

## 7. Top 10 Priority Fixes

| # | Issue | Severity | Effort | Impact |
|---|-------|----------|--------|--------|
| 1 | 5 empty event listeners in `eventListeners.ts` | **HIGH** | Small | Domain events fire into void |
| 2 | Extend Express `Request` type to eliminate ~80 `as any` casts | **HIGH** | Small | Type safety across entire backend |
| 3 | Add `take`/`limit` to WebSocket and sync service queries | **HIGH** | Medium | OOM prevention at scale |
| 4 | Add `Tenant` relation to `StockAlert` + 7 other models | **MEDIUM** | Small | Prevent orphaned data on tenant delete |
| 5 | Add Zod validation to printing, loyalty, stocktaking, shift routes | **MEDIUM** | Medium | Input injection prevention |
| 6 | Fix fire-and-forget `setTimeout` in `scheduled-report.routes.ts` | **LOW** | Trivial | Error swallowing |
| 7 | Track `setTimeout` ref in `rbac.service.ts` | **LOW** | Trivial | Memory leak prevention |
| 8 | Implement `sale.refunded` and `sale.voided` side effects | **MEDIUM** | Medium | Business logic completeness |
| 9 | Reduce `as any` casts in `printing.routes.ts` (30+) and `website-sync.routes.ts` (50+) | **LOW** | Large | Type safety |
| 10 | Add pagination to loyalty transaction and customer report queries | **LOW** | Small | Performance at scale |

---

*End of Bug Scan & Quality Report — Phase 6 deliverable*
